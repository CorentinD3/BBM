{% extends 'base.html.twig' %}

{% block meta_title %}
    Récapitulatif de la réservation
{% endblock %}


{% block body %}
    <!-- Conteneur principal -->
    <div class="lg:max-w-4xl w-full mx-auto px-6 py-16 bg-white shadow-2xl">
        <!-- Titre de la page -->
        <div class="flex lg:items-center items-start justify-between lg:flex-row flex-col border-b pb-4 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Récapitulatif avant confirmation</h1>
        </div>
        <!-- Zone d'affichage des erreurs -->
        <div id="errorMessage" class="hidden bg-red-100 text-red-700 border border-red-400 p-4 rounded mt-4"></div>
        <!-- Zone d'affichage des succès -->
        <div id="successMessage" class="hidden bg-green-100 text-green-700 border border-green-400 p-4 rounded mt-4"></div>

        <!-- Section de résumé de réservation -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-b pb-6 mb-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Détails de la réservation</h2>

                <!-- Prestation -->
                <div class="flex items-center mb-4">
                    <span class="inline-block w-10 h-10 bg-[#dbeafe] text-[#1e3a8a] rounded-full mr-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-6 w-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                    </span>
                    <div>
                        <p class="text-gray-500">Prestation :</p>
                        {% if reservation.prestation.label is defined %}
                        <p class="font-medium text-gray-900">{{ reservation.prestation.label }}</p>
                        <p class="font-medium text-gray-900">{{ reservation.prestation.variant }}</p>
                        {% else %}
                        <p class="font-medium text-gray-900">{{ reservation.prestation }}</p>
                        {% endif %}
                    </div>
                </div>
                <!-- Date -->
                <div class="flex items-center mb-4">
                    <span class="inline-block w-10 h-10 bg-[#e0f3e0] text-[#5d7f64] rounded-full mr-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                        </svg>
                    </span>
                    <div>
                        <p class="text-gray-500">Date :</p>
                        <p class="font-medium text-gray-900">{{ reservation.date }}</p>
                    </div>
                </div>

                <!-- Heure -->
                <div class="flex items-center mb-4">
                    <span class="inline-block w-10 h-10 bg-[#fef9c3] text-[#92400e] rounded-full mr-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                    </span>
                    <div>
                        <p class="text-gray-500">Heure :</p>
                        <p class="font-medium text-gray-900">{{ reservation.hour }}</p>
                    </div>
                </div>

                <!-- Lieu -->
                <div class="flex items-center mb-4">
                    <span class="inline-block w-10 h-10 bg-[#e9d5ff] text-[#6b21a8] rounded-full mr-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5V10a1 1 0 00-.293-.707l-8-8a1 1 0 00-1.414 0l-8 8A1 1 0 004 10v10h5" />
                        </svg>
                    </span>
                    <div>
                        <p class="text-gray-500">Lieu :</p>
                        <p class="font-medium text-gray-900">81 Rue Albert Cuenin, Dunkerque</p>
                    </div>
                </div>

                <!-- Durée -->
                <div class="flex items-center">
                    <span class="inline-block w-10 h-10 bg-[#f8d7da] text-[#8a4b4b] rounded-full mr-4 flex items-center justify-center">
                        <svg viewBox="0 0 24 24" class="w-6 h-6" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 3H19M19 3H5M19 3C19 5.51 17.79 7.87 15.75 9.32L12 12M5 3H4M5 3C5 5.51 6.21 7.87 8.25 9.32L12 12M20 21H19M19 21H5M19 21C19 18.49 17.79 16.13 15.75 14.67L12 12M5 21H4M5 21C5 18.49 6.21 16.13 8.25 14.67L12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    <div>
                        <p class="text-gray-500">Durée :</p>
                        {% set hours = reservation.duration|date('H') %}
                        {% set minutes = reservation.duration|date('i') %}
                        <p class="font-medium text-gray-900">
                            {% if hours != '00' %}
                                {{ hours }} heure{% if hours > 1 %}s{% endif %}
                            {% endif %}
                            {% if minutes != '00' %}
                                {{ minutes }} minute{% if minutes > 1 %}s{% endif %}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Prix -->
            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Résumé du paiement</h2>

                <!-- Prix de la prestation -->
                <div class="flex justify-between text-gray-600 mb-2">
                    <span>Prix de la prestation :</span>
                    <span>{{ reservation.price }} EUR</span>
                </div>

                {# Désactivation des taxes : on fixe taxes à 0 #}
                {% set taxes = 0 %}

                {#
                <div class="flex justify-between text-gray-600 mb-2">
                    <span>Taxes (20%) :</span>
                    <span>{{ taxes | number_format(2, '.', ',') }} EUR</span>
                </div>
                #}

                <!-- Total -->
                {% set total = reservation.price + taxes %}
                <div class="border-t pt-2 flex justify-between text-gray-900 font-semibold">
                    <span>Total :</span>
                    <span>{{ total | number_format(2, '.', ',') }} EUR</span>
                </div>
            </div>

        </div>

        <!-- Section d'informations sur le client -->
        <div class="border-b pb-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Informations du client</h2>
            <div class="flex items-center mb-4">
                <p class="text-gray-500 w-1/3">Nom :</p>
                <p class="font-medium text-gray-900">{{ reservation.user.firstName }} {{ reservation.user.lastName }} </p>
            </div>
            <div class="flex items-center mb-4">
                <p class="text-gray-500 w-1/3">Email :</p>
                <p class="font-medium text-gray-900">{{ reservation.user.email }}</p>
            </div>
            <div class="flex items-center">
                <p class="text-gray-500 w-1/3">Téléphone :</p>
                <p class="font-medium text-gray-900">{{ reservation.number }}</p>
            </div>
        </div>

        <!-- Politique de paiement -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Politique de Paiement</h2>
            <p class="text-gray-500 mb-2">Le règlement de la prestation s'effectue directement sur place, le jour de votre rendez-vous. Les modes de paiement acceptés sont les suivants :</p>
            <ul class="text-gray-500 mb-2 pl-6" style="list-style-type: disc;">
                <li>PayPal</li>
                <li>Lydia</li>
                <li>Espèces</li>
            </ul>
            <p class="text-gray-500">Veuillez noter que les paiements par chèque ou carte bancaire ne sont pas acceptés. Nous vous prions de vous assurer que vous disposez des moyens de paiement adéquats avant votre rendez-vous.</p>
        </div>

        <!-- Politique d'annulation -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Politique d'annulation</h2>
            <p class="text-gray-500">Toute annulation ou modification de votre réservation est possible sans frais jusqu'à 24 heures avant le rendez-vous. Au-delà de ce délai, des frais d'annulation peuvent être appliqués.</p>
        </div>

        <!-- Case à cocher pour confirmation des politiques -->
        <div class="pb-6  border-b">
            <label class="flex items-start md:items-center">
                <input type="checkbox" id="policy-confirmation" class="mr-2 mt-1 md:mt-0">
                <span class="text-gray-700">Je confirme avoir lu et accepté les
        <a href="#" class="text-blue-600 underline hover:text-blue-800">politiques de paiement</a>
        et les <a href="#" class="text-blue-600 underline hover:text-blue-800">conditions d'annulation</a>.
    </span>
            </label>
        </div>

        <!-- Boutons d'action -->
        <div class="flex lg:justify-end justify-center lg:flex-row flex-col lg:space-x-4 space-x-0 lg:space-y-0 space-y-3 mt-6">
            <button id="cancel-button" onclick="goBack();" class="flex items-center justify-center shadow text-[#8a4b4b] font-medium py-2 rounded-md bg-[#f8d7da] transition px-3 border-2 border-transparent hover:border-black border2 gap-2 sm:mt-0 mt-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                Annuler la réservation
            </button>
            <button id="confirm-button" class="flex items-center justify-center shadow text-[#5d7f64] font-medium py-2 rounded-md bg-[#e0f3e0] transition px-3 border-2 border-transparent hover:border-black border2 gap-2 sm:mt-0 mt-2 opacity-50 cursor-not-allowed pointer-events-none">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                </svg>
                Confirmer la réservation
            </button>
        </div>
    </div>
    <style>
        body {
            background-color: white!important;
        }
    </style>
    <script>
        let formSubmitted = false;

        // L'utilisateur confirme ou annule la réservation
        document.querySelector('#confirm-button').addEventListener('click', function() {
            formSubmitted = true;
        });

        document.querySelector('#cancel-button').addEventListener('click', function() {
            formSubmitted = true;
        });

        // Gérer la fermeture de l'onglet ou la navigation hors de la page
        window.addEventListener('beforeunload', function (e) {
            if (!formSubmitted) {
                e.preventDefault();
            }
        });

        // Désactiver le bouton de confirmation au départ
        const confirmButton = document.querySelector('#confirm-button');

        // Gestion de la case à cocher pour activer le bouton de confirmation
        document.querySelector('#policy-confirmation').addEventListener('change', function(e) {
            if (e.target.checked) {
                confirmButton.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
            } else {
                confirmButton.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
            }
        });

        // Retourne à la page précédente dans l'historique du navigateur
        function goBack() {
            window.history.back();
        }

        // Fonction d'affichage de messages
        function displayMessage(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.add('block');

            // Masquer le message après 5 secondes
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        // Gestion du clic sur le bouton de confirmation
        confirmButton.addEventListener('click', async function() {
            try {
                const response = await fetch('{{ path("api_finalize-appointment") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="tokenCalCli"]').getAttribute('content')
                    }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    displayMessage('successMessage', 'Réservation confirmée avec succès.');
                    window.location.href = '{{ path('app_confirmation-reservation') }}';
                } else {
                    console.error('Erreur lors de la confirmation de la réservation :', result.message);
                    displayMessage('errorMessage', result.message || 'Une erreur est survenue lors de la confirmation de la réservation.');
                    window.location.href = '{{ path('app_cal') }}';
                }
            } catch (error) {
                console.error('Erreur lors de la confirmation de la réservation :', error);
                displayMessage('errorMessage', 'Une erreur est survenue lors de la confirmation de la réservation.');
                window.location.href = '{{ path('app_cal') }}';
            }
        });

    </script>

{% endblock %}
